<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quáº£n LÃ½ Há»c Sinh 11A4 - Firebase Ultimate</title>
    <style>
        /* GIá»® NGUYÃŠN TOÃ€N Bá»˜ PHáº¦N CSS Cá»¦A Báº N */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header-section { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #007bff; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; color: #2c3e50; font-size: 24px; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; display: inline-block; }
        .role-super { background: #6610f2; color: #fff; }
        .role-admin { background: #d1e7dd; color: #0f5132; }
        .role-user { background: #cfe2ff; color: #084298; }
        .role-guest { background: #f8d7da; color: #842029; }
        .stats-bar { display: flex; gap: 15px; background: #e7f1ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #004085; font-weight: 600; flex-wrap: wrap; }
        .stats-item span { color: #dc3545; font-size: 1.2em; margin-left: 5px; }
        .panel { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .panel.active { display: block; animation: fadeIn 0.5s; }
        .admin-title { font-weight: bold; margin-bottom: 15px; color: #856404; text-transform: uppercase; border-bottom: 1px solid #ffeeba; padding-bottom: 5px; font-size: 14px; }
        .form-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        input, select, textarea { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; outline: none; }
        button { cursor: pointer; padding: 10px 15px; border: none; border-radius: 6px; color: white; font-weight: 600; transition: 0.2s; font-size: 14px; }
        .btn-add { background-color: #198754; grid-column: 1 / -1; }
        .btn-edit { background-color: #ffc107; color: #000; font-size: 12px; padding: 5px 8px; }
        .btn-delete { background-color: #dc3545; font-size: 12px; padding: 5px 8px; }
        .btn-excel { background-color: #198754; }
        .btn-save-notice { background-color: #fd7e14; margin-top: 10px; }
        .log-section { background: white; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .log-header { background: #6610f2; color: white; display: grid; grid-template-columns: 120px 150px 1fr; }
        .log-header div { padding: 10px; font-weight: bold; font-size: 12px; text-transform: uppercase; border-right: 1px solid rgba(255,255,255,0.2); }
        .log-body { max-height: 250px; overflow-y: auto; }
        .log-row { display: grid; grid-template-columns: 120px 150px 1fr; border-bottom: 1px solid #eee; }
        .log-row div { padding: 8px 10px; font-size: 12px; border-right: 1px solid #eee; }
        .table-responsive { overflow-x: auto; border-radius: 8px; box-shadow: 0 0 0 1px #dee2e6; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background-color: #007bff; color: white; text-transform: uppercase; font-size: 13px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 500px; max-width: 95%; position: relative; }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; color: #aaa; }
        .notice-content { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; white-space: pre-wrap; }
        .search-input { flex: 1; max-width: 300px; padding: 10px; border: 2px solid #007bff; border-radius: 6px; margin-bottom: 10px;}
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>ğŸ“ Quáº£n LÃ½ Lá»›p 11A4</h1>
        <div class="admin-controls">
            <span id="userStatus" class="status-badge role-guest">KhÃ¡ch</span>
            <button id="btnAuth" style="background:#0d6efd" onclick="moFormDangNhap()">ğŸ”‘ ÄÄƒng nháº­p</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stats-item">Tá»•ng sÄ© sá»‘: <span id="tongSiSo">0</span></div>
        <div class="stats-item">Nam: <span id="tongNam">0</span> ğŸ‘¦</div>
        <div class="stats-item">Ná»¯: <span id="tongNu">0</span> ğŸ‘§</div>
        <div class="stats-item">ÄoÃ n viÃªn: <span id="tongDoanVien">0</span> ğŸ‡»ğŸ‡³</div>
    </div>

    <div id="superAdminPanel" class="panel">
        <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px;">
            <div>
                <div class="admin-title">ğŸ›¡ï¸ Quáº£n lÃ½ tÃ i khoáº£n phá»¥</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1.2fr 80px; gap: 5px; margin-bottom: 10px;">
                    <input type="text" id="newUsername" placeholder="User">
                    <input type="text" id="newPassword" placeholder="Pass">
                    <select id="newRole">
                        <option value="admin">PhÃ³ Admin</option>
                        <option value="user">ThÃ nh viÃªn</option>
                    </select>
                    <button style="background:#6610f2" onclick="themTaiKhoan()">Táº¡o</button>
                </div>
                <div class="table-responsive">
                    <table style="min-width: auto; font-size: 12px;">
                        <thead><tr><th>USER</th><th>ROLE</th><th>HÃ€NH Äá»˜NG</th></tr></thead>
                        <tbody id="bodyTaiKhoan"></tbody>
                    </table>
                </div>
            </div>
            <div>
                <div class="admin-title">ğŸ“œ Nháº­t kÃ½ hoáº¡t Ä‘á»™ng</div>
                <div class="log-section">
                    <div class="log-header"><div>Thá»i gian</div><div>NgÆ°á»i dÃ¹ng</div><div>HÃ nh Ä‘á»™ng</div></div>
                    <div class="log-body" id="bodyLog"></div>
                </div>
                <button style="background:#dc3545; width: 100%; margin-top:5px" onclick="xoaLog()">ğŸ—‘ï¸ XÃ³a Lá»‹ch Sá»­</button>
            </div>
        </div>
    </div>

    <div id="adminArea" class="panel">
        <div class="admin-title">ğŸ› ï¸ ThÃªm há»c sinh má»›i</div>
        <div class="form-group">
            <input type="text" id="hoTen" placeholder="Há» vÃ  TÃªn">
            <select id="gioiTinh"><option value="Nam">Nam</option><option value="Ná»¯">Ná»¯</option></select>
            <select id="doanVien"><option value="ChÆ°a">ChÆ°a vÃ o ÄoÃ n</option><option value="ÄoÃ n viÃªn">ÄoÃ n viÃªn</option></select>
            <input type="text" id="danToc" placeholder="DÃ¢n tá»™c">
            <input type="text" id="ngaySinh" placeholder="NgÃ y sinh">
            <input type="text" id="sdt" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i">
            <input type="text" id="email" placeholder="Email">
            <input type="text" id="queQuan" placeholder="QuÃª quÃ¡n">
            <input type="text" id="diaChi" placeholder="Äá»‹a chá»‰">
            <button class="btn-add" onclick="themHocSinh()">â• ThÃªm Há»c Sinh</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <div class="admin-title">ğŸ“¢ ThÃ´ng bÃ¡o lá»›p</div>
                <textarea id="txtNoiDungThongBao" rows="3"></textarea>
                <button class="btn-save-notice" style="width:100%" onclick="luuThongBaoMoi()">ğŸ’¾ LÆ°u ThÃ´ng BÃ¡o</button>
            </div>
            <div>
                <div class="admin-title">ğŸ“Š Xuáº¥t file</div>
                <button class="btn-excel" style="width: 100%; padding: 15px;" onclick="xuatHocSinhExcel()">ğŸ“¥ Táº¢I DANH SÃCH (.CSV)</button>
            </div>
        </div>
    </div>

    <input type="text" id="searchInput" class="search-input" onkeyup="timKiemHocSinh()" placeholder="ğŸ” TÃ¬m kiáº¿m há»c sinh...">

    <div class="table-responsive">
        <table>
            <thead><tr><th>STT</th><th>Há» TÃªn</th><th>Giá»›i TÃ­nh</th><th>ÄoÃ n ViÃªn</th><th>DÃ¢n Tá»™c</th><th>NgÃ y Sinh</th><th>SÄT</th><th>Email</th><th>QuÃª QuÃ¡n</th><th>Äá»‹a Chá»‰</th><th>HÃ nh Äá»™ng</th></tr></thead>
            <tbody id="thanBang"></tbody>
        </table>
    </div>
</div>

<div id="noticeModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="dongThongBao()">&times;</span><div id="hienThiNoiDungTB" class="notice-content"></div></div></div>
<div id="loginModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="dongFormDangNhap()">&times;</span><input type="text" id="loginUser" placeholder="User"><input type="password" id="loginPass" placeholder="Pass"><button onclick="xuLyDangNhap()">ÄÄ‚NG NHáº¬P</button></div></div>
<div id="editModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="dongFormSua()">&times;</span><input type="hidden" id="editId"><input type="text" id="editHoTen"><button onclick="luuCapNhatHS()">LÆ¯U</button></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Cáº¥u hÃ¬nh Firebase láº¥y tá»« hÃ¬nh áº£nh cá»§a báº¡n
    const firebaseConfig = {
        apiKey: "AIzaSyD1hji2xKwW43bxwP-3GIcPU0L7GfVc Lg",
        authDomain: "list11a4.firebaseapp.com",
        projectId: "list11a4",
        storageBucket: "list11a4.firebasestorage.app",
        messagingSenderId: "260918440128",
        appId: "1:260918440128:web:06936db27f3814cf5d7d25"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Biáº¿n toÃ n cá»¥c Ä‘á»ƒ dÃ¹ng trong cÃ¡c function onclick
    window.currentRole = 'guest';
    window.currentUser = 'KhÃ¡ch';
    window.danhSachHocSinh = [];

    // 1. Láº¤Y Dá»® LIá»†U Tá»° Äá»˜NG Tá»ª FIREBASE
    onValue(ref(db, 'students'), (snapshot) => {
        const data = snapshot.val();
        window.danhSachHocSinh = data ? Object.keys(data).map(key => ({ fbId: key, ...data[key] })) : [];
        hienThiHocSinh();
    });

    onValue(ref(db, 'notice'), (snapshot) => {
        const nd = snapshot.val() || "ChÃ o má»«ng lá»›p 11A4!";
        document.getElementById("hienThiNoiDungTB").innerText = nd;
        document.getElementById("txtNoiDungThongBao").value = nd;
    });

    // 2. CÃC HÃ€M Xá»¬ LÃ Dá»® LIá»†U
    window.themHocSinh = function() {
        let t = document.getElementById("hoTen").value;
        if(!t) return alert("Nháº­p tÃªn!");
        const newHs = {
            hoTen: t, gioiTinh: document.getElementById("gioiTinh").value,
            doanVien: document.getElementById("doanVien").value, danToc: document.getElementById("danToc").value,
            ngaySinh: document.getElementById("ngaySinh").value, sdt: document.getElementById("sdt").value,
            email: document.getElementById("email").value, queQuan: document.getElementById("queQuan").value,
            diaChi: document.getElementById("diaChi").value
        };
        push(ref(db, 'students'), newHs);
        ghiLog(`ThÃªm há»c sinh: ${t}`);
        ["hoTen","danToc","ngaySinh","sdt","email","queQuan","diaChi"].forEach(id => document.getElementById(id).value = "");
    };

    window.xoaHocSinh = function(fbId, ten) {
        if(confirm(`XÃ³a há»c sinh ${ten}?`)) {
            remove(ref(db, `students/${fbId}`));
            ghiLog(`XÃ³a há»c sinh: ${ten}`);
        }
    };

    window.luuThongBaoMoi = function() {
        const nd = document.getElementById("txtNoiDungThongBao").value;
        set(ref(db, 'notice'), nd);
        ghiLog("Thay Ä‘á»•i thÃ´ng bÃ¡o");
        alert("ÄÃ£ lÆ°u!");
    };

    // 3. HIá»‚N THá»Š GIAO DIá»†N (Sá»¬A Láº I Tá»ª CODE CÅ¨)
    window.hienThiHocSinh = function(data = window.danhSachHocSinh) {
        let tbody = document.getElementById("thanBang"), html = '';
        let canEdit = (window.currentRole === 'super_admin' || window.currentRole === 'admin');
        let canView = (window.currentRole !== 'guest');

        data.forEach((hs, i) => {
            html += `<tr>
                <td>${i+1}</td>
                <td><b>${hs.hoTen}</b></td>
                <td style="color:${hs.gioiTinh==='Nam'?'blue':'deeppink'}">${hs.gioiTinh}</td>
                <td>${hs.doanVien === 'ÄoÃ n viÃªn' ? 'ğŸ‡»ğŸ‡³' : 'ChÆ°a'}</td>
                <td>${canView ? hs.danToc : '***'}</td><td>${canView ? hs.ngaySinh : '***'}</td>
                <td>${canView ? hs.sdt : '***'}</td><td>${canView ? hs.email : '***'}</td>
                <td>${canView ? hs.queQuan : '***'}</td><td>${canView ? hs.diaChi : '***'}</td>
                <td>${canEdit ? `<button class="btn-delete" onclick="xoaHocSinh('${hs.fbId}', '${hs.hoTen}')">XÃ³a</button>` : '---'}</td>
            </tr>`;
        });
        tbody.innerHTML = html || '<tr><td colspan="11" style="text-align:center">Trá»‘ng</td></tr>';
        document.getElementById("tongSiSo").innerText = window.danhSachHocSinh.length;
    };

    // LOGS & AUTH (Váº«n dÃ¹ng LocalStorage cho Ä‘Æ¡n giáº£n hoáº·c báº¡n cÃ³ thá»ƒ chuyá»ƒn lÃªn Firebase tÆ°Æ¡ng tá»±)
    window.ghiLog = function(action) {
        console.log(`Log: ${window.currentUser} - ${action}`);
        // CÃ³ thá»ƒ push log lÃªn Firebase ref(db, 'logs')
    };

    window.xuLyDangNhap = function() {
        let u = document.getElementById("loginUser").value, p = document.getElementById("loginPass").value;
        if(u==='trannhuthang' && p==='26032009') { window.currentRole = 'super_admin'; window.currentUser = 'Thang'; }
        else { window.currentRole = 'guest'; return alert("Sai!"); }
        document.getElementById("loginModal").style.display = "none";
        capNhatGiaoDien();
    };

    window.capNhatGiaoDien = function() {
        document.getElementById("adminArea").style.display = (window.currentRole!=='guest') ? 'block' : 'none';
        document.getElementById("userStatus").innerText = window.currentUser;
        hienThiHocSinh();
    };

    window.moFormDangNhap = () => document.getElementById("loginModal").style.display = "flex";
    window.dongFormDangNhap = () => document.getElementById("loginModal").style.display = "none";
    window.dongThongBao = () => document.getElementById("noticeModal").style.display = "none";
    
    // Tá»± Ä‘á»™ng hiá»‡n thÃ´ng bÃ¡o khi vÃ o web
    setTimeout(() => document.getElementById("noticeModal").style.display = "flex", 1000);
</script>
</body>
</html>